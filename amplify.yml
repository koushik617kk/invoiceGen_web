version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Install dependencies
        - echo "Installing dependencies..."
        - npm ci
        # Verify Node.js and npm versions
        - node --version
        - npm --version
        # Check if environment variables are set
        - echo "Environment check:"
        - echo "VITE_API_BASE: $VITE_API_BASE"
        - echo "VITE_ENVIRONMENT: $VITE_ENVIRONMENT"
        # Create production environment file if not exists
        - |
          if [ ! -f .env.production ]; then
            echo "Creating .env.production file..."
            cat > .env.production << EOF
          # Production Environment - Auto-generated by Amplify
          VITE_API_BASE=${VITE_API_BASE:-https://api.invoiceGen.in}
          VITE_ENVIRONMENT=${VITE_ENVIRONMENT:-production}
          EOF
          fi
    build:
      commands:
        # Build the application
        - echo "Building application..."
        - npm run build
        # Verify build output
        - echo "Build completed. Checking dist folder..."
        - ls -la dist/
        - echo "Build size:"
        - du -sh dist/
    postBuild:
      commands:
        # Verify build artifacts
        - echo "Post-build verification..."
        - test -f dist/index.html || (echo "index.html not found!" && exit 1)
        - test -d dist/assets || (echo "assets directory not found!" && exit 1)
        # Show build summary
        - echo "Build summary:"
        - echo "Total files in dist: $(find dist -type f | wc -l)"
        - echo "Largest files:"
        - find dist -type f -exec du -h {} + | sort -rh | head -10
  artifacts:
    # Important: The baseDirectory should be 'dist' for Vite builds
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .npm/**/*
      - .yarn/**/*
